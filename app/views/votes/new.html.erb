<% content_for :head do %>
  <%= preload_link_tag asset_path("peaceful_glade.mp3"), as: :audio %>
  <%= preload_link_tag asset_path("luce.wav"), as: :audio %>
  <%= preload_link_tag asset_path("viscosity.wav"), as: :audio %>
  <%= preload_link_tag asset_path("meowmeow.wav"), as: :audio %>

  <% if @projects.present? %>
    <% @projects.each do |project| %>
      <!-- Preload project banners -->
      <%= preload_link_tag url_for(project.banner), as: :image %>

      <!-- Preload user avatars -->
      <% project.devlogs.each do |devlog| %>
        <% if devlog.user.avatar.present? && !devlog.user.avatar.blank? %>
          <%= preload_link_tag devlog.user.avatar, as: :image %>
        <% end %>

        <!-- Preload devlog attachments -->
        <% if devlog.file.attached? %>
          <% if devlog.file.image? %>
            <%= preload_link_tag url_for(devlog.file), as: :image %>
          <% elsif devlog.file.video? %>
            <%= preload_link_tag url_for(devlog.file), as: :video %>
          <% elsif devlog.file.audio? %>
            <%= preload_link_tag url_for(devlog.file), as: :audio %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

<div class="container mx-auto px-0 sm:px-4 pt-2 md:pt-8">
  <h1 class="text-4xl sm:text-5xl mb-2 sm:text-center">Vote</h1>
  <p class="text-center text-nice-blue text-lg mb-6">You have voted <%= @user_vote_count %> times.</p>

  <%= admin_tool { @projects } %>
  <% if @projects.size < 2 %>
    <%= render layout: "shared/container" do %>
      <div class="h-full text-center mt-8">
        <p class="mb-6 sm:mb-8 text-black text-large sm:text-xl 2xl:text-2xl">There aren't enough projects in the pool to vote on. Check back later for more projects!</p>
        <%= link_to explore_path, class: "px-4 sm:px-6 py-2 sm:py-3 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel" do %>
          Explore Projects
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div data-controller="voting-steps"
      data-action="music:played@window->voting-steps#handleMusicPlayed"
      class="space-y-6 sm:space-y-8">

      <h2 class="text-lg sm:text-xl md:text-2xl mb-6 sm:mb-8 text-center text-gray-600">
        A good ship is technical, creative, and tells the story of how it was made.<br>
        By that definition, which of these two projects is better?
      </h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-0 sm:gap-16 mobile-divide-dashed">
        <% @projects.each do |project| %>
          <div class="px-4 py-8 sm:py-4 bg-[#F6DBBA] sm:rounded-xl">
            <div class="space-y-6 sm:space-y-8">
              <div class="flex items-start gap-3 sm:gap-4">
                <div class="h-16 w-16 sm:h-20 sm:w-20 flex-shrink-0 overflow-hidden rounded-lg">
                  <%= image_tag project.banner, alt: project.title, class: "w-full h-full object-cover" %>
                </div>
                <div class="flex-grow min-w-0">
                  <h3 class="text-xl sm:text-3xl mb-1 sm:mb-2 truncate"><%= project.title %></h3>

                  <div class="flex flex-wrap items-center space-x-2 mb-2 text-sm text-gray-600">
                    <span class="text-gray-800"><%= project.devlogs_count %></span>
                    <span><%= "devlog".pluralize(project.devlogs_count) %></span>
                    <span>â€¢</span>
                    <% total_time_seconds = project.hackatime_total_time %>
                    <span class="text-gray-800"><%= format_seconds(total_time_seconds) %></span>
                  </div>

                  <div class="text-base sm:text-lg text-gray-600"
                       data-controller="devlog-card"
                       data-devlog-card-max-length-value="150">
                    <div data-devlog-card-target="content"><%= project.description %></div>
                  </div>
                </div>
              </div>

              <div class="space-y-4 sm:space-y-6">
                <div class="grid grid-cols-1 sm:flex sm:flex-wrap gap-3 sm:gap-4">
                  <% if project.demo_link.present? %>
                    <a href="<%= project.demo_link %>" target="_blank"
                      class="px-4 sm:px-6 py-2.5 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 btn-pixel text-base sm:text-lg 2xl:text-xl text-center"
                      onclick="event.stopPropagation()"
                      data-analytics-link="demo"
                      data-action="mousedown->voting-steps#trackLinkClick touchstart->voting-steps#trackLinkClick keydown->voting-steps#trackLinkClick">
                      Demo
                    </a>
                  <% end %>
                  <% if project.repo_link.present? %>
                    <a href="<%= project.repo_link %>" target="_blank"
                      class="px-4 sm:px-6 py-2.5 bg-nice-blue hover:scale-[1.05] text-white transition-transform duration-300 btn-pixel text-base sm:text-lg 2xl:text-xl text-center"
                      onclick="event.stopPropagation()"
                      data-analytics-link="repo"
                      data-action="mousedown->voting-steps#trackLinkClick touchstart->voting-steps#trackLinkClick keydown->voting-steps#trackLinkClick">
                      Repository
                    </a>
                  <% end %>
                  <% if project.readme_link.present? %>
                    <a href="<%= project.readme_link %>" target="_blank"
                      class="px-4 sm:px-6 py-2.5 bg-saddle-taupe hover:scale-[1.05] text-white transition-transform duration-300 btn-pixel text-base sm:text-lg 2xl:text-xl text-center"
                      onclick="event.stopPropagation()"
                      data-analytics-link="readme"
                      data-action="mousedown->voting-steps#trackLinkClick touchstart->voting-steps#trackLinkClick keydown->voting-steps#trackLinkClick">
                        Readme
                    </a>
                  <% end %>
                </div>
              </div>

              <div class="space-y-4 sm:space-y-8">
                <% project.devlogs.order(created_at: :asc).each do |devlog| %>
                  <%= render "devlogs/devlog_card",
                      devlog: devlog,
                      context: 'voting',
                      show_comments_inline: false,
                      show_comment_modal: false,
                      show_likes: false,
                      content_margin: 'p-4 sm:p-6' %>
                <% end %>
              </div>
              </div>
            </div>
        <% end %>
      </div>

      <div class="mt-8 sm:mt-12">
        <%= render layout: "shared/card" do %>
          <div class="p-2 sm:p-4">
            <%= render "form", vote: @vote %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<!-- Music Player Toggle -->
<div data-controller="music" class="fixed -bottom-32 -right-12 max-sm:mb-[140px]">
  <div data-music-target="speechBubble" class="absolute -top-12 -left-10 2xl:-top-16 2xl:-left-12 p-3 bg-[#F3ECD8] rounded-2xl border-4 border-[#E4DCC6] max-w-[150px] opacity-50">
    <div class="text-sm text-forest font-medium">Click me, please!</div>
  </div>
  <button
    data-music-target="toggle"
    data-action="click->music#toggleMusic"
    class="w-24 h-24 sm:w-48 sm:h-48 2xl:w-64 2xl:h-64 hover:scale-110 transition-transform duration-300 flex items-center justify-center overflow-hidden"
    title="Toggle Journey Music">
    <%= image_tag "journeypheusmusic.png", alt: "Toggle Music", class: "w-full h-full object-contain" %>

    <div data-music-target="audioTracks" class="hidden">
      <%= audio_tag "peaceful_glade.mp3", class: "music-track", data: { track_name: "peaceful_glade" } %>
      <%= audio_tag "luce.wav", class: "music-track", data: { track_name: "luce" } %>
      <%= audio_tag "viscosity.wav", class: "music-track", data: { track_name: "viscosity" } %>
      <%= audio_tag "meowmeow.wav", class: "music-track", data: { track_name: "meowmeow" } %>
    </div>
  </button>
</div>

<!-- Image Viewer for Attachments -->
<div data-controller="image-viewer">
  <div data-image-viewer-target="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-75" data-action="click->image-viewer#closeBackground">
    <div class="relative max-w-7xl max-h-[90vh] w-full flex items-center justify-center">
      <button class="absolute top-2 right-2 md:top-4 md:right-4 text-white p-2 hover:scale-110 transition-transform z-10" data-action="image-viewer#close">
        <%= inline_svg "close.svg", class: "h-6 w-6 md:h-8 md:w-8" %>
      </button>
      <img data-image-viewer-target="image" class="max-h-[85vh] max-w-full object-contain" src="" alt="Full size image">
    </div>
  </div>
</div>
