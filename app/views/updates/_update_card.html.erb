<%
  # Default parameter values
  context ||= 'default'                    # 'explore', 'project', 'activity', 'stonk'
  show_project_title ||= false             # Whether to show project title
  show_project_navigation ||= false        # Whether the card should navigate to project (onClick)
  show_likes ||= false                     # Whether to show like button
  show_comment_modal ||= false             # Whether to show comment button/icon (w/ number of comments)
  show_comments_inline ||= false           # Whether to show comments inline
  show_edit_delete ||= false               # Whether to show edit/delete buttons for owner
  show_stonks ||= false                    # Whether to show stonks count
  container_classes ||= ''                 # Additional container classes
  content_margin ||= ''                    # Content margin/padding classes
%>

<div class="bg-soft-bone <%= context == 'explore' || context == 'project' ? 'card-pixel' : '' %> <%= context == 'project' ? 'p-3 sm:p-4' : 'p-4 sm:p-6' %> <%= container_classes %> transform hover:scale-[1.01] transition-transform duration-300 <%= 'cursor-pointer' if show_project_navigation %> <%= 'max-w-4xl 2xl:max-w-6xl mx-auto' if context == 'explore' %>"
     id="<%= dom_id(update) %>"
     data-controller="modal"
     <% if show_project_navigation %> onclick="window.location.href='<%= project_path(update.project) %>'"<% end %>>

  <div class="flex items-center mb-2 sm:mb-3">
    <% if update.user.avatar.present? %>
      <img src="<%= update.user.avatar %>" alt="<%= update.user.display_name %>" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full mr-2 sm:mr-3">
    <% end %>
    <div>
      <span class="font-medium text-base sm:text-lg 2xl:text-xl"><%= update.user.display_name %></span>
      <span class="text-gray-600 text-xs sm:text-sm 2xl:text-base ml-2"><%= time_ago_in_words(update.created_at) %> ago</span>

      <!-- Time info -->
      <% if update.timer_sessions.any? %>
        <% timer_session = update.timer_sessions.first %>
        <span class="text-forest text-xs sm:text-sm 2xl:text-base ml-2 block sm:inline">
          <% hours = timer_session.net_time / 3600 %>
          <% minutes = (timer_session.net_time % 3600) / 60 %>
          <% seconds = timer_session.net_time % 60 %>
          <%= image_tag "hourglass.png", class: "w-4 h-4 inline-block" %> Time spent: <%= hours > 0 ? "#{hours}h " : "" %><%= minutes > 0 ? "#{minutes}m " : "" %><%= seconds > 0 ? "#{seconds}s" : "" %>
        </span>
      <% elsif update.last_hackatime_time.present? && update.last_hackatime_time > 0 %>
        <span class="text-forest text-xs sm:text-sm 2xl:text-base ml-2 block sm:inline">
          <% hours = update.last_hackatime_time / 3600 %>
          <% minutes = (update.last_hackatime_time % 3600) / 60 %>
          <% seconds = update.last_hackatime_time % 60 %>
          <%= image_tag "hourglass.png", class: "w-4 h-4 inline-block" %> Time spent: <%= hours > 0 ? "#{hours}h " : "" %><%= minutes > 0 ? "#{minutes}m " : "" %><%= seconds > 0 ? "#{seconds}s" : "" %>
        </span>
      <% end %>

      <!-- Stonks info -->
      <% if show_stonks %>
        <span class="text-saddle-taupe text-xs sm:text-sm 2xl:text-base ml-2 block sm:inline">
          <%= image_tag "stonkcoin.png", class: "w-4 h-4 inline-block mr-1", alt: "Stonks" %>
          <%= update.project.stonks.count %> stonkers
        </span>
      <% end %>
    </div>
  </div>

  <div class="<%= content_margin.present? ? content_margin : 'ml-10 sm:ml-13' %>">
    <!-- Project title-->
    <% if show_project_title %>
      <h3 class="text-lg sm:text-xl 2xl:text-2xl font-steven mb-2"><%= update.project.title %></h3>
    <% end %>

    <!-- Update content -->
    <div class="prose max-w-none text-gray-600 mb-2 sm:mb-3 text-sm sm:text-base 2xl:text-lg break-words overflow-wrap-anywhere">
      <%= update.formatted_text %>
    </div>

    <!-- Attachments -->
    <% if update.attachment.present? %>
      <div class="mt-2 sm:mt-3 flex justify-center">
        <% attachment_url = update.attachment %>
        <% clean_url = attachment_url.gsub(/\?pub_secret=.*$/, '') %>
        <% if clean_url.match?(/\.(jpg|jpeg|png|gif|heic|heif|webp)$/i) %>
          <img src="<%= attachment_url %>" alt="Update attachment" class="max-w-full max-h-96 object-contain cursor-pointer hover:opacity-90 transition-opacity rounded-lg" data-action="click->image-viewer#open">
        <% elsif clean_url.match?(/\.(mp4|webm|mov)$/i) %>
          <div class="h-48 sm:h-64 flex items-center justify-center bg-black rounded-lg">
            <video src="<%= attachment_url %>" class="w-full h-full object-contain rounded-lg" playsinline controls>
              Your browser does not support the video tag.
            </video>
          </div>
        <% elsif update.attachment.match?(/\.(mp3|wav|m4a|ogg|flac)$/i) %>
          <div class="w-full h-48 sm:h-64 flex items-center justify-center">
            <audio src="<%= update.attachment %>" class="w-[50%]" controls controlsList="nodownload">
              Your browser does not support the audio tag.
            </audio>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Action buttons -->
    <div class="mt-3 sm:mt-4 flex <%= context == 'project' ? 'justify-end' : 'justify-between' %> items-center">
      <!-- Left side: Like and Comment buttons -->
      <% if show_likes || show_comment_modal %>
        <div class="flex items-center space-x-4">
          <% if show_likes && user_signed_in? %>
            <%= render "likes/button", likeable: update %>
          <% end %>

          <% if show_comment_modal && user_signed_in? %>
            <button data-action="click->modal#open" data-modal-id="<%= update.id %>" data-modal-type="comment" class="inline-flex items-center py-1 sm:py-1.5 text-gray-600 hover:text-forest transition-colors duration-300 text-sm sm:text-base" onclick="event.stopPropagation()">
              <%= inline_svg_tag "comment.svg", class: "w-6 h-6 sm:w-10 sm:h-10 mr-2" %>
              <%= update.comments.count %>
            </button>
          <% end %>
        </div>
      <% end %>

      <!-- Right side: Edit/Delete/Add Comment buttons (for project timeline) -->
      <!-- TODO: Probably move these left too and redesign inline comments -->
      <% if show_edit_delete || (context == 'project') %>
        <div class="flex items-center flex-wrap gap-3 md:gap-4">
          <% if user_signed_in? && current_user == update.user && show_edit_delete %>
            <button data-action="click->modal#open" data-modal-id="<%= update.id %>" data-modal-type="edit" class="px-2 md:px-4 py-2 <%= defined?(@project) && @project&.is_shipped? ? 'hidden' : 'bg-forest hover:scale-[1.05]' %> text-white transition-all duration-300 text-sm md:text-base 2xl:text-large btn-pixel edit-update-btn" <%= 'disabled' if defined?(@project) && @project&.is_shipped? %>>
              Edit
            </button>
          <% end %>

          <% if context == 'project' %>
            <button data-action="click->modal#open" data-modal-id="<%= update.id %>" data-modal-type="comment" class="px-2 md:px-4 py-2 bg-nice-blue hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel">
              Add Comment
            </button>
          <% end %>

          <% if user_signed_in? && current_user == update.user && show_edit_delete %>
            <%= button_to "Delete", project_update_path(update.project, update),
                method: :delete,
                class: "px-2 md:px-4 py-2 #{defined?(@project) && @project&.is_shipped? ? 'hidden' : 'bg-vintage-red hover:scale-[1.05]'} text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel delete-button",
                data: { controller: "delete-confirmation", action: "click->delete-confirmation#confirm" },
                disabled: (defined?(@project) && @project&.is_shipped?) %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Inline comments -->
  <% if show_comments_inline %>
    <div id="comments-<%= update.id %>" class="mt-4 ml-4 sm:ml-6 space-y-3">
      <%= render update.comments %>
    </div>
  <% end %>
</div>

<!-- Render comment modal based on context -->
<% if show_comment_modal || context == 'project' %>
  <%= render "comments/modal", update: update %>
<% end %>

<!-- Edit Modal (only for project owner) -->
<!-- TODO: Move this to a separate partial -->
<% if user_signed_in? && current_user == update.user && (show_edit_delete || context == 'project') %>
  <div class="modal hidden fixed inset-0 z-50 overflow-auto bg-black/30 flex items-center justify-center p-2 md:p-4 min-h-screen" id="edit-modal-<%= update.id %>" data-controller="modal edit-modal">
    <div class="bg-soft-bone w-full max-w-2xl card-pixel mx-2 md:mx-auto relative" data-modal-target="container">
      <div class="p-3 md:p-4 border-b border-saddle-taupe border-opacity-30">
        <div class="flex justify-between items-center">
          <h3 class="text-lg md:text-2xl font-steven">Edit Your Update</h3>
          <button type="button" class="text-gray-600 hover:text-vintage-red cursor-pointer" data-action="click->modal#close">
            <%= inline_svg_tag "close.svg", class: "h-6 w-6 2xl:h-8 2xl:w-8" %>
          </button>
        </div>
      </div>

      <div class="p-3 md:p-4">
        <div class="text-center mb-4">
          <h4 class="text-lg md:text-xl font-steven mb-2">Edit Guidelines</h4>
          <p class="text-sm md:text-base mb-4 text-gray-600">
            You can only edit the formatting of your update (markdown, spaces, line breaks).
            <br>
            <span class="text-vintage-red">You cannot add or remove text content.</span>
          </p>
        </div>

        <%= form_with model: update,
            url: project_update_path(update.project, update),
            method: :patch,
            id: "edit-form-#{update.id}",
            class: "space-y-3",
            data: {
              turbo: true,
              edit_modal_target: "form"
            } do |f| %>
          <div class="space-y-2">
            <%= f.text_area :text,
                class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base rounded-none",
                rows: 6,
                data: { edit_modal_target: "text", original_text: update.text } %>
            <p class="text-xs md:text-sm text-vintage-red hidden edit-error-message" data-edit-modal-target="error"></p>
          </div>

          <div class="flex flex-row justify-end space-x-4">
            <button type="button" class="px-2 md:px-4 py-2 bg-vintage-red hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" data-action="click->modal#close">
              Cancel
            </button>
            <%= f.submit "Save Changes", class: "px-2 md:px-4 py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
